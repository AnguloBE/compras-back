// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// Enums
enum RolUsuario {
  USUARIO
  ADMIN
  REPARTIDOR
}

enum EstadoPedido {
  PENDIENTE
  CONFIRMADO
  EN_PREPARACION
  EN_CAMINO
  ENTREGADO
  CANCELADO
}

enum UnidadMedida {
  L    // Litros
  ML   // Mililitros
  KG   // Kilogramos
  GR   // Gramos
  PZ   // Piezas
  MTR  // Metros
}

enum DiaSemana {
  LUNES
  MARTES
  MIERCOLES
  JUEVES
  VIERNES
  SABADO
  DOMINGO
}

// Modelos
model Usuario {
  id                 String      @id @default(cuid())
  nombre             String      // Obligatorio
  telefono           String      @unique
  fechaNacimiento    DateTime?
  codigoVerificacion String?     // Código temporal para login
  codigoExpiracion   DateTime?   // Cuándo expira el código
  rol                RolUsuario  @default(USUARIO)
  
  // Relaciones
  pedidos            Pedido[]
  pedidosEntregados  Pedido[]    @relation("Repartidor")
  
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt

  @@map("usuarios")
}

model Categoria {
  id          String        @id @default(cuid())
  nombre      String        @unique
  descripcion String?
  activo      Boolean       @default(true)
  
  // Relaciones
  productos   Producto[]
  
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@map("categorias")
}

model Ubicacion {
  id          String   @id @default(cuid())
  nombre      String   @unique
  costo       Decimal  @db.Decimal(10, 2)
  activo      Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("ubicaciones")
}

model Producto {
  id              String        @id @default(cuid())
  nombre          String
  codigoBarras    String?       @unique
  marca           String?
  contenido       String?       // Ej: "500ml", "1kg"
  medida          UnidadMedida? // Unidad de medida: L, KG, PZ, MTR
  descripcion     String?       @db.Text
  precioCompra    Decimal       @db.Decimal(10, 2) @default(0)
  precioVenta     Decimal       @db.Decimal(10, 2)
  stock           Decimal       @db.Decimal(10, 2)
  imagen          String?       // URL de la imagen
  activo          Boolean       @default(true)
  permiteEncargo  Boolean       @default(false) // Para panes/roscas
  
  categoriaId     String
  categoria       Categoria     @relation(fields: [categoriaId], references: [id])
  
  // Relaciones
  detallesPedido  DetallePedido[]
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@map("productos")
  @@index([categoriaId])
  @@index([codigoBarras])
}

model Pedido {
  id              String        @id @default(cuid())
  numeroOrden     String        @unique @default(cuid())
  
  usuarioId       String
  usuario         Usuario       @relation(fields: [usuarioId], references: [id])
  
  repartidorId    String?
  repartidor      Usuario?      @relation("Repartidor", fields: [repartidorId], references: [id])
  
  estado          EstadoPedido  @default(PENDIENTE)
  
  // Costos
  subtotal        Decimal       @db.Decimal(10, 2)
  costoEnvio      Decimal       @db.Decimal(10, 2) @default(0)
  total           Decimal       @db.Decimal(10, 2)
  
  // Ubicación de envío
  ubicacionEnvio  String?       // Angostura, Alhuey, etc.
  
  // Fechas
  fechaEncargo    DateTime?     // Para pedidos programados
  fechaEntrega    DateTime?
  
  notas           String?       @db.Text
  
  // Relaciones
  detalles        DetallePedido[]
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@map("pedidos")
  @@index([usuarioId])
  @@index([repartidorId])
  @@index([estado])
}

model DetallePedido {
  id          String   @id @default(cuid())
  
  pedidoId    String
  pedido      Pedido   @relation(fields: [pedidoId], references: [id], onDelete: Cascade)
  
  productoId  String
  producto    Producto @relation(fields: [productoId], references: [id])
  
  cantidad    Decimal @db.Decimal(10, 2)
  precioUnitario Decimal @db.Decimal(10, 2)
  subtotal    Decimal @db.Decimal(10, 2)
  
  createdAt   DateTime @default(now())

  @@map("detalles_pedido")
  @@index([pedidoId])
  @@index([productoId])
}

model HorarioAtencion {
  id          String     @id @default(cuid())
  dia         DiaSemana
  horaApertura String   // Formato "HH:mm" ej: "09:00"
  horaCierre   String   // Formato "HH:mm" ej: "18:00"
  cerrado     Boolean   @default(false) // true si el negocio está cerrado ese día
  activo      Boolean   @default(true)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([dia, activo]) // Solo un horario activo por día
  @@map("horarios_atencion")
}
